(()=>{function w(n){let t=atob(n),s=t.length,i=new Uint8Array(s);for(let e=0;e<s;e++)i[e]=t.charCodeAt(e);return i}function S(n){return n.map(t=>[t>>8&255,t&255]).flat()}function L(n){let t=[];for(let s=0;s<n.length;s+=2)t.push(n[s]<<8|n[s+1]);return t}function x(n){return Array.from(n).map(t=>t.charCodeAt(0))}var g=class{#e;#s;#r;#t;#i=null;brushSize;currentColor;w;h;constructor(t,s,i=1,e="black",o=1){this.#e=document.createElement("canvas"),this.#t=[],this.#e.width=t,this.#e.height=s,this.w=t,this.h=s,this.#s="",this.brushSize=i,this.currentColor=e,this.#r=this.#e.getContext("2d")}#o(t,s){return Math.hypot(t.x-s.x,t.y-s.y)}resetLogPoint(){this.#i=null}drawCircle(t=5,s=0,i=0){t>255||(this.#r.beginPath(),this.#r.arc(s,i,t,0,2*Math.PI),this.#r.fillStyle=this.currentColor,this.#r.fill(),(!this.#i||this.#o(this.#i,{x:s,y:i})>=t/2)&&(this.#s+=`CIRCLE ${t} ${~~s} ${~~i}
`,this.#t.push(1,t,...S([~~s,~~i])),this.#i={x:s,y:i}))}out(){return this.#e.toDataURL()}getBinary(){return this.#t}getLog(){return this.#s}wipe(){this.#r.fillStyle="#FFFFFF",this.#r.fillRect(0,0,this.w,this.h),this.#s="",this.#t=[]}loadFromLog(t){this.wipe();let s=t.split(`
`);for(let i of s){let e=i.split(" "),o=e[0];if(o==="SETCOLOR"){let r=e[1];this.setColor(r)}else if(o==="CIRCLE"){let r=e[1],h=e[2],a=e[3];this.drawCircle(r,h,a)}}}loadFromBinary(t,s=!0){this.#s="",this.#t=[];let i=0;for(;i<t.length;)switch(t[i]){case 1:let e=t[++i],o=[];for(let l=0;l<4;l++)i++,o.push(t[i]);this.drawCircle(e,...L(o)),i++;break;case 2:let r=t[++i],h=t.slice(i+1,i+1+r),a=String.fromCharCode(...h);i+=r,this.setColor(a);break;default:i++;break}}setSize(t){this.brushSize=t}setColor(t){this.currentColor=t,this.#s+=`SETCOLOR ${t}
`,this.#t.push(2,t.length,...x(t))}fromBase64(t,s=!0){return this.loadFromBinary(Array.from(w(t,s)))}toBase64(){let t="";for(let s=0;s<this.#t.length;s++)t+=String.fromCharCode(this.#t[s]);return btoa(t)}},b=class{#e;#s;#r=[];#t;#i;#o=null;constructor(t,s=1,i="black",e=1){this.publicCanvas=t,this.#e=document.createElement("canvas"),this.#i=[],this.#e.width=t.width,this.#e.height=t.height,this.w=t.width,this.h=t.height,this.#s="",this.brushSize=s,this.#t=this.#e.getContext("2d"),this.minSize=e,this.currentColor=i}#n(t,s){return Math.hypot(t.x-s.x,t.y-s.y)}resetLogPoint(){this.#o=null}drawCircle(t=5,s=0,i=0){this.#t.beginPath(),this.#t.arc(s,i,t,0,2*Math.PI),this.#t.fillStyle=this.currentColor,this.#t.fill(),(!this.#o||this.#n(this.#o,{x:s,y:i})>=t/2)&&(this.#s+=`CIRCLE ${t} ${~~s} ${~~i}
`,this.#i.push(1,t,...S([~~s,~~i])),this.#o={x:s,y:i})}draw(){let t=this.publicCanvas.getContext("2d");t.clearRect(0,0,this.w,this.h),t.drawImage(this.#e,0,0)}out(){return this.#e.toDataURL()}getBinary(){return this.#i}getLog(){return this.#s}wipe(){this.#t.fillStyle="#FFFFFF",this.#t.fillRect(0,0,this.w,this.h),this.draw(),this.#s="",this.#i=[],this.resetLogPoint()}loadFromLog(t){this.#s="",this.wipe();let s=t.split(`
`);for(let i of s){let e=i.split(" "),o=e[0];if(o=="CIRCLE"){let r=Number(e[1]),h=Number(e[2]),a=Number(e[3]);this.drawCircle(r,h,a)}if(o=="SETCOLOR"){let r=e[1];this.setColor(r)}}this.draw()}loadFromBinary(t,s=!0){this.#s="",this.#i=[];let i=0;for(;i<t.length;)switch(t[i]){case 1:let e=t[++i],o=[];for(let l=0;l<4;l++)i++,o.push(t[i]);this.drawCircle(e,...L(o)),i++;break;case 2:let r=t[++i],h=t.slice(i+1,i+1+r),a=String.fromCharCode(...h);i+=r,this.setColor(a);break;default:i++;break}s&&this.draw()}setColor(t){this.currentColor=t,this.#s+=`SETCOLOR ${t}
`,this.#i.push(2,t.length,...x(t))}setSize(t){this.brushSize=t}fromBase64(t,s=!0){return this.loadFromBinary(Array.from(w(t,s)))}toBase64(){let t="";for(let s=0;s<this.#i.length;s++)t+=String.fromCharCode(this.#i[s]);return btoa(t)}},f=b,C=g;var u=class{constructor(t,s,i="black"){this.canvas=t,this.object=new f(t,5,i,1),this.isDrawing=!1,this.lastX=null,this.lastY=null,this.listen(),this.export=this.out,this.setColor(i),this.object.wipe()}setBrushSize(t){return this.object.setSize(t),t}setColor(t){return this.object.setColor(t),t}clear(){this.object.wipe(),this.lastX=null,this.lastY=null}exportAs(t){if(typeof t>"u")throw new Error("Datatype is a required parameter for exportAs.");switch(t.trim().toLowerCase()){case"base64":return this.object.toBase64();case"binary":return this.object.getBinary();case"log":case"raw":case"text":return this.object.getLog();default:return this.object.getLog()}}out(t="base64"){switch(t.trim().toLowerCase()){case"base64":return this.object.toBase64();case"binary":return this.object.getBinary();case"log":case"raw":case"text":return this.object.getLog();default:return this.object.getLog()}}listen(){this.canvas.addEventListener("mousedown",(t=>{this.isDrawing=!0,this.object.resetLogPoint();let s=this.canvas.getBoundingClientRect();this.lastX=t.clientX-s.left,this.lastY=t.clientY-s.top,this.object.drawCircle(this.object.brushSize,this.lastX,this.lastY),this.object.draw()}).bind(this)),document.addEventListener("mouseup",(()=>{this.isDrawing=!1,this.lastX=null,this.lastY=null}).bind(this)),document.addEventListener("mouseleave",(()=>{this.isDrawing=!1,this.lastX=null,this.lastY=null}).bind(this)),document.addEventListener("mousemove",(t=>{if(!this.isDrawing)return;let s=this.canvas.getBoundingClientRect(),i=t.clientX-s.left,e=t.clientY-s.top;if(this.lastX!==null&&this.lastY!==null){let o=i-this.lastX,r=e-this.lastY,h=Math.hypot(o,r),a=Math.ceil(h/2);for(let l=0;l<=a;l++){let c=this.lastX+o*l/a,m=this.lastY+r*l/a;this.object.drawCircle(this.object.brushSize,c,m)}this.object.draw()}this.lastX=i,this.lastY=e}).bind(this)),this.canvas.addEventListener("touchstart",(t=>{t.preventDefault(),this.isDrawing=!0,this.object.resetLogPoint();let s=this.canvas.getBoundingClientRect(),i=t.touches[0];this.lastX=i.clientX-s.left,this.lastY=i.clientY-s.top,this.object.drawCircle(this.object.brushSize,this.lastX,this.lastY),this.object.draw()}).bind(this),{passive:!1}),document.addEventListener("touchend",(()=>{this.isDrawing=!1,this.lastX=null,this.lastY=null}).bind(this)),document.addEventListener("touchcancel",(()=>{this.isDrawing=!1,this.lastX=null,this.lastY=null}).bind(this)),document.addEventListener("touchmove",(t=>{if(!this.isDrawing)return;t.preventDefault();let s=this.canvas.getBoundingClientRect(),i=t.touches[0],e=i.clientX-s.left,o=i.clientY-s.top;if(this.lastX!==null&&this.lastY!==null){let r=e-this.lastX,h=o-this.lastY,a=Math.hypot(r,h),l=Math.ceil(a/2);for(let c=0;c<=l;c++){let m=this.lastX+r*c/l,j=this.lastY+h*c/l;this.object.drawCircle(this.object.brushSize,m,j)}this.object.draw()}this.lastX=e,this.lastY=o}).bind(this),{passive:!1})}};function B(n){let t=n.trim().split(`
`),s=[],i=0,e=0;for(let r of t)r.startsWith("SETCOLOR")?(e>0&&s.push(i),e++,i=0):r.startsWith("CIRCLE")&&i++;return e===0?null:e===1?0:s.reduce((r,h)=>r+h,0)/s.length}function p(n,t={usesExactColor:!1,minSize:1}){if(t.minAverageSCD){let i=B(n);if(i==null||i==0)return!0;if(i<t.minAverageSCD)return!1}let s=n.split(`
`);for(let i of s){let e=i.split(" "),o=e[1];if(e[0]=="SETCOLOR"){let r=e[1];if((r.startsWith("#")||r.startsWith("rgb"))&&t.exactColor)return!1}if(t.minSize&&Number(o)<t.minSize)return!1}return!0}var d=class{constructor(t,s){this.validationSettings=s,this.usesHumanization=!!s.minAverageSCD,this.exactColor=s.allowExactColor||!1,this.pc=t,this.object=new f(t,1,"black",s.minBrushSize),this.minBrushSize=this.validationSettings.minBrushSize,this.object.wipe()}loadBase64(t){let s=new C(this.pc.width,this.pc.height,1,"black",this.minBrushSize);s.fromBase64(t);let i=s.getLog(),e=p(i,{exactColor:this.exactColor,minSize:this.minBrushSize,minAverageSCD:this.usesHumanization?this.validationSettings.minAverageSCD:null});return e&&this.object.loadFromLog(i),e}loadBinary(t){let s=new C(this.pc.width,this.pc.height,1,"black",this.minBrushSize);s.loadFromBinary(t);let i=s.getLog(),e=p(i,{exactColor:this.exactColor,minSize:this.minBrushSize,minAverageSCD:this.usesHumanization?this.validationSettings.minAverageSCD:null});return e&&this.object.loadFromLog(i),e}clear(){this.object.wipe()}};var y={Canvas:u,Display:d};window.SecureDraw=y;})();
