function y(a){let t=atob(a),i=t.length,s=new Uint8Array(i);for(let e=0;e<i;e++)s[e]=t.charCodeAt(e);return s}function g(a){return Array.from(a).map(t=>t.charCodeAt(0))}var C=class{#e;#s;#r;#t;#i=null;brushSize;currentColor;w;h;constructor(t,i,s=1,e="black",o=1,r){this.#e=document.createElement("canvas"),this.#t=[],this.#e.width=t,this.#e.height=i,this.w=t,this.h=i,this.#s="",this.brushSize=s,this.currentColor=e,this.#r=this.#e.getContext("2d"),this.accuracy=r}#o(t,i){return Math.hypot(t.x-i.x,t.y-i.y)}resetLogPoint(){this.#i=null}drawCircle(t=5,i=0,s=0){if(!(t>255)&&(this.#r.beginPath(),this.#r.arc(i,s,t,0,2*Math.PI),this.#r.fillStyle=this.currentColor,this.#r.fill(),!this.#i||this.#o(this.#i,{x:i,y:s})!==0)){this.#s+=`CIRCLE ${t} ${i.toFixed(this.accuracy)} ${s.toFixed(this.accuracy)}
`;let e=i.toFixed(this.accuracy)+","+s.toFixed(this.accuracy);this.#t.push(1,t,...g(`${String.fromCharCode(e.length)}${e}`)),this.#i={x:i,y:s}}}out(){return this.#e.toDataURL()}getBinary(){return this.#t}getLog(){return this.#s}wipe(){this.#r.fillStyle="#FFFFFF",this.#r.fillRect(0,0,this.w,this.h),this.#s="",this.#t=[]}loadFromLog(t){this.wipe();let i=t.split(`
`);for(let s of i){let e=s.split(" "),o=e[0];if(o==="SETCOLOR"){let r=e[1];this.setColor(r)}else if(o==="CIRCLE"){let r=e[1],n=e[2],c=e[3];this.drawCircle(r,n,c)}}}loadFromBinary(t,i=!0){this.#s="",this.#t=[];let s=0;for(;s<t.length;)switch(t[s]){case 1:let e=t[++s],o="",r=t[++s];for(let d=0;d<r;d++)s++,o+=String.fromCharCode(t[s]);let[n,c]=o.split(",");this.drawCircle(e,+n,+c),s++;break;case 2:let h=t[++s],l=t.slice(s+1,s+1+h),u=String.fromCharCode(...l);s+=h,this.setColor(u);break;default:s++;break}}setSize(t){this.brushSize=t}setColor(t){this.currentColor=t,this.#s+=`SETCOLOR ${t}
`,this.#t.push(2,t.length,...g(t))}fromBase64(t,i=!0){return this.loadFromBinary(Array.from(y(t,i)))}toBase64(){let t="";for(let i=0;i<this.#t.length;i++)t+=String.fromCharCode(this.#t[i]);return btoa(t)}},p=class{#e;#s;#r=[];#t;#i;#o=null;constructor(t,i=1,s="black",e=1,o){this.publicCanvas=t,this.#e=document.createElement("canvas"),this.#i=[],this.#e.width=t.width,this.#e.height=t.height,this.w=t.width,this.h=t.height,this.#s="",this.brushSize=i,this.#t=this.#e.getContext("2d"),this.minSize=e,this.currentColor=s,this.accuracy=o}#n(t,i){return Math.hypot(t.x-i.x,t.y-i.y)}resetLogPoint(){this.#o=null}drawCircle(t=5,i=0,s=0){if(this.#t.beginPath(),this.#t.arc(i,s,t,0,2*Math.PI),this.#t.fillStyle=this.currentColor,this.#t.fill(),!this.#o||this.#o.x!==i||this.#o.y!==s){this.#s+=`CIRCLE ${t} ${i.toFixed(this.accuracy)} ${s.toFixed(this.accuracy)}
`;let e=i.toFixed(this.accuracy)+","+s.toFixed(this.accuracy);this.#i.push(1,t,...g(`${String.fromCharCode(e.length)}${e}`)),this.#o={x:i,y:s}}}draw(){let t=this.publicCanvas.getContext("2d");t.clearRect(0,0,this.w,this.h),t.drawImage(this.#e,0,0)}out(){return this.#e.toDataURL()}getBinary(){return this.#i}getLog(){return this.#s}wipe(){this.#t.fillStyle="#FFFFFF",this.#t.fillRect(0,0,this.w,this.h),this.draw(),this.#s="",this.#i=[],this.resetLogPoint()}loadFromLog(t){this.#s="",this.wipe();let i=t.split(`
`);for(let s of i){let e=s.split(" "),o=e[0];if(o=="CIRCLE"){let r=Number(e[1]),n=Number(e[2]),c=Number(e[3]);this.drawCircle(r,n,c)}if(o=="SETCOLOR"){let r=e[1];this.setColor(r)}}this.draw()}loadFromBinary(t,i=!0){this.#s="",this.#i=[];let s=0;for(;s<t.length;)switch(t[s]){case 1:let e=t[++s],o="",r=t[++s];for(let d=0;d<r;d++)s++,o+=String.fromCharCode(t[s]);let[n,c]=o.split(",");this.drawCircle(e,+n,+c),s++;break;case 2:let h=t[++s],l=t.slice(s+1,s+1+h),u=String.fromCharCode(...l);s+=h,this.setColor(u);break;default:s++;break}}setColor(t){this.currentColor=t,this.#s+=`SETCOLOR ${t}
`,this.#i.push(2,t.length,...g(t))}setSize(t){this.brushSize=t}fromBase64(t,i=!0){return this.loadFromBinary(Array.from(y(t,i)))}toBase64(){let t="";for(let i=0;i<this.#i.length;i++)t+=String.fromCharCode(this.#i[i]);return btoa(t)}},b=p,w=C;var f=class{constructor(t,i,s="black",e){if(this.canvas=t,typeof e>"u")throw new Error("Canvas requires options object in lossless mode.");if(!e.accuracy)throw new Error("Canvas options require property accuracy in lossless mode.");if(e.accuracy%1!==0)throw new Error("Canvas accuracy cannot be a decimal.");if(!Number.isFinite(e.accuracy))throw new Error("Canvas accuracy must be an integer.");this.accuracy=Math.min(20,e.accuracy),this.object=new b(t,5,s,1,this.accuracy),this.isDrawing=!1,this.lastX=null,this.lastY=null,this.setColor(s),this.listen(),this.export=this.out,this.object.wipe()}setBrushSize(t){return this.object.setSize(t),t}setColor(t){return this.object.setColor(t),t}clear(){this.object.wipe(),this.lastX=null,this.lastY=null}exportAs(t){if(typeof t>"u")throw new Error("Datatype is a required parameter for exportAs.");switch(t.trim().toLowerCase()){case"base64":return this.object.toBase64();case"binary":return this.object.getBinary();case"log":case"raw":case"text":return this.object.getLog();default:return this.object.getLog()}}out(t="base64"){switch(t.trim().toLowerCase()){case"base64":return this.object.toBase64();case"binary":return this.object.getBinary();case"log":case"raw":case"text":return this.object.getLog();default:return this.object.getLog()}}listen(){this.canvas.addEventListener("mousedown",(t=>{this.isDrawing=!0,this.object.resetLogPoint();let i=this.canvas.getBoundingClientRect();this.lastX=t.clientX-i.left,this.lastY=t.clientY-i.top,this.object.drawCircle(this.object.brushSize,this.lastX,this.lastY),this.object.draw()}).bind(this)),document.addEventListener("mouseup",(()=>{this.isDrawing=!1,this.lastX=null,this.lastY=null}).bind(this)),document.addEventListener("mouseleave",(()=>{this.isDrawing=!1,this.lastX=null,this.lastY=null}).bind(this)),document.addEventListener("mousemove",(t=>{if(!this.isDrawing)return;let i=this.canvas.getBoundingClientRect(),s=t.clientX-i.left,e=t.clientY-i.top;if(this.lastX!==null&&this.lastY!==null){let o=s-this.lastX,r=e-this.lastY,n=Math.hypot(o,r),c=Math.ceil(n/2);for(let h=0;h<=c;h++){let l=this.lastX+o*h/c,u=this.lastY+r*h/c;this.object.drawCircle(this.object.brushSize,l,u)}this.object.draw()}this.lastX=s,this.lastY=e}).bind(this)),this.canvas.addEventListener("touchstart",(t=>{t.preventDefault(),this.isDrawing=!0,this.object.resetLogPoint();let i=this.canvas.getBoundingClientRect(),s=t.touches[0];this.lastX=s.clientX-i.left,this.lastY=s.clientY-i.top,this.object.drawCircle(this.object.brushSize,this.lastX,this.lastY),this.object.draw()}).bind(this),{passive:!1}),document.addEventListener("touchend",(()=>{this.isDrawing=!1,this.lastX=null,this.lastY=null}).bind(this)),document.addEventListener("touchcancel",(()=>{this.isDrawing=!1,this.lastX=null,this.lastY=null}).bind(this)),document.addEventListener("touchmove",(t=>{if(!this.isDrawing)return;t.preventDefault();let i=this.canvas.getBoundingClientRect(),s=t.touches[0],e=s.clientX-i.left,o=s.clientY-i.top;if(this.lastX!==null&&this.lastY!==null){let r=e-this.lastX,n=o-this.lastY,c=Math.hypot(r,n),h=Math.ceil(c/2);for(let l=0;l<=h;l++){let u=this.lastX+r*l/h,d=this.lastY+n*l/h;this.object.drawCircle(this.object.brushSize,u,d)}this.object.draw()}this.lastX=e,this.lastY=o}).bind(this),{passive:!1})}};function x(a){let t=a.trim().split(`
`),i=[],s=0,e=0;for(let r of t)r.startsWith("SETCOLOR")?(e>0&&i.push(s),e++,s=0):r.startsWith("CIRCLE")&&s++;return e===0?null:e===1?0:i.reduce((r,n)=>r+n,0)/i.length}function S(a,t={usesExactColor:!1,minSize:1}){if(t.minAverageSCD){let s=x(a);if(s==null||s==0)return!0;if(s<t.minAverageSCD)return!1}let i=a.split(`
`);for(let s of i){let e=s.split(" "),o=e[1];if(e[0]=="SETCOLOR"){let r=e[1];if((r.startsWith("#")||r.startsWith("rgb"))&&t.exactColor)return!1}if(t.minSize&&Number(o)<t.minSize)return!1}return!0}var m=class{constructor(t,i){this.validationSettings=i,this.usesHumanization=!!i.minAverageSCD,this.exactColor=i.allowExactColor||!1,this.pc=t,this.object=new b(t,1,"black",i.minBrushSize),this.minBrushSize=this.validationSettings.minBrushSize,this.object.wipe()}loadBase64(t){let i=new w(this.pc.width,this.pc.height,1,"black",this.minBrushSize);i.fromBase64(t);let s=i.getLog(),e=S(s,{exactColor:this.exactColor,minSize:this.minBrushSize,minAverageSCD:this.usesHumanization?this.validationSettings.minAverageSCD:null});return e&&this.object.loadFromLog(s),e}loadBinary(t){let i=new w(this.pc.width,this.pc.height,1,"black",this.minBrushSize);i.loadFromBinary(t);let s=i.getLog(),e=S(s,{exactColor:this.exactColor,minSize:this.minBrushSize,minAverageSCD:this.usesHumanization?this.validationSettings.minAverageSCD:null});return e&&this.object.loadFromLog(s),e}clear(){this.object.wipe()}};var R={Canvas:f,Display:m};export{R as default};
